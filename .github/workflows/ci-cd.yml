name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # Frontend Build
  frontend-build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Build PWA
        working-directory: ./frontend
        run: npm run build

      - name: Upload Frontend Build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          retention-days: 5

  # Backend Build & Test
  backend-build:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: venlab_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Create Schema
        env:
          PGPASSWORD: testpass
        run: |
          psql -h localhost -U testuser -d venlab_test -c "CREATE SCHEMA IF NOT EXISTS venlab;"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build Backend
        working-directory: ./libs/vue-crud/libs/vue-datatable/libs/backend
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/venlab_test?currentSchema=venlab
          SPRING_DATASOURCE_USERNAME: testuser
          SPRING_DATASOURCE_PASSWORD: testpass
          SPRING_JPA_HIBERNATE_DDL_AUTO: create-drop
        run: ./gradlew build

      - name: Upload Backend JAR
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: libs/vue-crud/libs/vue-datatable/libs/backend/build/libs/*.jar
          retention-days: 5

  # Deploy Info
  deploy:
    needs: [frontend-build, backend-build]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Deployment Ready
        run: |
          echo "## Deployment Ready " >> $GITHUB_STEP_SUMMARY
          echo "- Frontend: " >> $GITHUB_STEP_SUMMARY
          echo "- Backend: " >> $GITHUB_STEP_SUMMARY